<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Tour and Hotel Recommendation</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <!-- css  -->
    <link rel="stylesheet" href="public/css/sty.css">
    <script type="text/javascript" src="./public/javascript/nav.js"></script>


</head>

<body>
    <input type="text" id="searchtext" placeholder="search">
    <button onclick="showsearch()"> Search</button>
    <section class="tour" id="tour">
     <div class="main-container" id="main-container">
       <div class="tour-cards">
        <div class="image-box">
            <img src="https://images.unsplash.com/photo-1491466424936-e304919aada7?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=869&q=80"
                alt="Stakkholtsgja canyon ">
            <div class="overlay"></div>
            <div class="image-box-text">
                <h2>Stakkholtsgja</h2>
                <p>Mountains & Waterfall</p>
            </div>

        </div>
        <div class="tour-cards-text">
            <h1>Stakkholtsgja canyon Trip</h1>
            <p>A Week long trip around the south iceland with hiking guides. Stakkholtsgjá is a wondrous
                canyon, situated in Southern part of the Icelandic Highlands. It is highly-known for the
                magical hiking trail that leads to a majestic waterfall. The gorge is a part of the
                Þórsmörk
                Nature Reserve. Every bit
                of Stakkholtsgjá canyon shines out with picturesque beauty. Stakkholtsgjá is about a
                hundred
                meters deep.</p>
            <a href="#" class="btn-map">

                <span>View Route Map</span>
            </a>
            <div class="price">
                <p>$5200 <span>Per person</span></p>
                <h2>18 Days 36 Nights</h2>
            </div>
        </div>
    </div>
</div>
</section>
<script>
    function getCookie(name) {
    const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return cookieValue ? cookieValue.pop() : '';
                
}
    const getuserid  = async () =>{
            try{
                const response =  await fetch('http://localhost:3000/api/v1/users/getuserfromtoken', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    token:getCookie('token')
                                })
                            })
                const data =  await response.json()
                return data
            }
            catch(err){
                console.log(err)
            }
        } 
    const resultsDiv = document.getElementById('main-container')
        
        fetch('http://localhost:3000/api/v1/tours',{
            method:'GET'
        })
            .then(response => response.json())
            .then(data => {
        
        
            data.data.forEach(async tour => {
                const tourDiv = document.createElement('div');
tourDiv.classList.add('tour-cards');

const imageBox = document.createElement('div');
imageBox.classList.add('image-box');

const image = document.createElement('img');
image.setAttribute('src', 'https://images.unsplash.com/photo-1491466424936-e304919aada7?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=869&q=80');
image.setAttribute('alt', 'Stakkholtsgja canyon ');

const overlay = document.createElement('div');
overlay.classList.add('overlay');

const imageBoxText = document.createElement('div');
imageBoxText.classList.add('image-box-text');

const h2 = document.createElement('h2');
h2.textContent = 'Stakkholtsgja';

const p = document.createElement('p');
p.textContent = 'Mountains & Waterfall';

imageBoxText.appendChild(h2);
imageBoxText.appendChild(p);

imageBox.appendChild(image);
imageBox.appendChild(overlay);
imageBox.appendChild(imageBoxText);

const tourCardsText = document.createElement('div');
tourCardsText.classList.add('tour-cards-text');

const h1 = document.createElement('h1');
h1.textContent = tour.name;

const p2 = document.createElement('p');
p2.textContent = tour.summary;

const price = document.createElement('div');
price.classList.add('price');

const p3 = document.createElement('p');
p3.textContent = tour.price + ' ';
const span = document.createElement('span');
span.textContent = 'Per person';
p3.appendChild(span);

const h22 = document.createElement('h2');
h22.textContent = 'Duration:' + tour.duration;

price.appendChild(p3);
price.appendChild(h22);

tourCardsText.appendChild(h1);
tourCardsText.appendChild(p2);
tourCardsText.appendChild(price);
tourDiv.appendChild(imageBox);
tourDiv.appendChild(tourCardsText);        
const response =  await fetch(`http://localhost:3000/api/v1/tours/numberofbookings/${tour._id}`)
const data =  await response.json()
if(tour.maxGroupSize >= data){
    const button = document.createElement('button');
    button.addEventListener('click', function() {
    booktour(tour._id, tour.price);
    });
    button.textContent = 'Book Tour';
    tourDiv.appendChild(button);
}
else {
    const full = document.createElement('p')
    p.innerText = 'SEATS NOT AVAILABLE'
    tourDiv.appendChild(full)
}

               






      resultsDiv.appendChild(tourDiv);
    });
})
.catch(error => console.error(error));
async function booktour(tour,price){
    const user = await getuserid()
    const userid = user._id
    const paid = false;
    try {
                    const response = await fetch('http://localhost:3000/api/v1/booking', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            tour,
                            userid,
                            price,
                            paid

                        })
                    });
    
                    const data = await response.json();
                   if(data){
                       alert('You have booked a tour')
                   }
                } catch (error) {
                    console.log(error);
                }
}
function showsearch(){
    const searchtext = document.getElementById('searchtext').value;
    const resultsDiv = document.getElementById('main-container')
    resultsDiv.innerHTML = ''
        
        fetch(`http://localhost:3000/api/v1/tours/search?q=${searchtext}`,{
            method:'GET'
        })
            .then(response => response.json())
            .then(data => {
                
        
            data.data.tours.forEach(async tour => {
                console.log(tour)
                const tourDiv = document.createElement('div');
tourDiv.classList.add('tour-cards');

const imageBox = document.createElement('div');
imageBox.classList.add('image-box');

const image = document.createElement('img');
image.setAttribute('src', 'https://images.unsplash.com/photo-1491466424936-e304919aada7?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=869&q=80');
image.setAttribute('alt', 'Stakkholtsgja canyon ');

const overlay = document.createElement('div');
overlay.classList.add('overlay');

const imageBoxText = document.createElement('div');
imageBoxText.classList.add('image-box-text');

const h2 = document.createElement('h2');
h2.textContent = 'Stakkholtsgja';

const p = document.createElement('p');
p.textContent = 'Mountains & Waterfall';

imageBoxText.appendChild(h2);
imageBoxText.appendChild(p);

imageBox.appendChild(image);
imageBox.appendChild(overlay);
imageBox.appendChild(imageBoxText);

const tourCardsText = document.createElement('div');
tourCardsText.classList.add('tour-cards-text');

const h1 = document.createElement('h1');
h1.textContent = tour.name;

const p2 = document.createElement('p');
p2.textContent = tour.summary;

const price = document.createElement('div');
price.classList.add('price');

const p3 = document.createElement('p');
p3.textContent = tour.price + ' ';
const span = document.createElement('span');
span.textContent = 'Per person';
p3.appendChild(span);

const h22 = document.createElement('h2');
h22.textContent = 'Duration:' + tour.duration;

price.appendChild(p3);
price.appendChild(h22);

tourCardsText.appendChild(h1);
tourCardsText.appendChild(p2);
tourCardsText.appendChild(price);
tourDiv.appendChild(imageBox);
tourDiv.appendChild(tourCardsText);        
const response =  await fetch(`http://localhost:3000/api/v1/tours/numberofbookings/${tour._id}`)
const data =  await response.json()
if(tour.maxGroupSize >= data){
    const button = document.createElement('button');
    button.addEventListener('click', function() {
    booktour(tour._id, tour.price);
    });
    button.textContent = 'Book Tour';
    tourDiv.appendChild(button);
}
else {
    const full = document.createElement('p')
    p.innerText = 'SEATS NOT AVAILABLE'
    tourDiv.appendChild(full)
}

               






      resultsDiv.appendChild(tourDiv);
    });
})
}
</script>
</body>
</html>